<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التوزيع الاحترافي للمهام التعليمية - سلطال الوليعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        :root {
            --navy: #0a192f;
            --royal-blue: #1e40af;
            --soft-blue: #eff6ff;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            color: var(--navy);
        }

        .gradient-header {
            background: linear-gradient(135deg, #0a192f 0%, #1e3a8a 100%);
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--royal-blue);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--navy);
            transform: translateY(-1px);
        }

        .period-box {
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .period-box.selected {
            border-color: var(--accent);
            background-color: var(--soft-blue);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .head-medal {
            color: #fbbf24;
            filter: drop-shadow(0 0 2px rgba(251, 191, 36, 0.4));
        }
    </style>
</head>
<body class="bg-slate-50">

    <header class="gradient-header text-white py-8 mb-8 shadow-lg">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-2">نظام التوزيع الذكي للمهام التعليمية</h1>
            <p class="text-blue-100 opacity-90 text-lg">بوابة إدارة الحصص والإشراف والعدالة الزمنية</p>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-20">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 rounded-2xl flex items-center space-x-reverse space-x-4 border-r-4 border-blue-600">
                <div class="bg-blue-100 p-3 rounded-xl"><i class="fas fa-users text-blue-600 text-xl"></i></div>
                <div>
                    <p class="text-sm text-gray-500 font-bold">إجمالي المعلمين</p>
                    <h3 class="text-2xl font-black" id="stat-total-teachers">0</h3>
                </div>
            </div>
            <div class="card p-6 rounded-2xl flex items-center space-x-reverse space-x-4 border-r-4 border-indigo-600">
                <div class="bg-indigo-100 p-3 rounded-xl"><i class="fas fa-clock text-indigo-600 text-xl"></i></div>
                <div>
                    <p class="text-sm text-gray-500 font-bold">متوسط العبء</p>
                    <h3 class="text-2xl font-black" id="stat-avg-time">0 س</h3>
                </div>
            </div>
            <div class="card p-6 rounded-2xl flex items-center space-x-reverse space-x-4 border-r-4 border-emerald-600">
                <div class="bg-emerald-100 p-3 rounded-xl"><i class="fas fa-balance-scale text-emerald-600 text-xl"></i></div>
                <div>
                    <p class="text-sm text-gray-500 font-bold">مؤشر العدالة</p>
                    <h3 class="text-2xl font-black" id="stat-fairness">100%</h3>
                </div>
            </div>
            <div class="card p-6 rounded-2xl flex items-center space-x-reverse space-x-4 border-r-4 border-amber-600">
                <div class="bg-amber-100 p-3 rounded-xl"><i class="fas fa-layer-group text-amber-600 text-xl"></i></div>
                <div>
                    <p class="text-sm text-gray-500 font-bold">إجمالي الحصص</p>
                    <h3 class="text-2xl font-black" id="stat-total-periods">0</h3>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                <section class="card p-6 rounded-2xl shadow-sm border-t-4 border-blue-900">
                    <h2 id="form-title" class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-user-plus text-blue-900"></i> إضافة معلم جديد
                    </h2>
                    
                    <div class="space-y-4">
                        <input type="hidden" id="edit-teacher-id" value="">
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">اسم المعلم</label>
                            <input type="text" id="teacher-name" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="مثال: أ. محمد العلي">
                        </div>

                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                            <input type="checkbox" id="is-head" class="w-5 h-5 accent-blue-900">
                            <label for="is-head" class="text-sm font-bold cursor-pointer">رئيس قسم (يقلل مهام الإشراف)</label>
                        </div>

                        <div class="space-y-3">
                            <p class="text-sm font-bold text-gray-700">توزيع الحصص الأسبوعي:</p>
                            <div class="max-h-96 overflow-y-auto custom-scrollbar pr-2 space-y-4" id="days-container">
                                </div>
                        </div>

                        <button id="save-btn" onclick="addTeacher()" class="w-full btn-primary text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> حفظ المعلم
                        </button>
                        <button id="cancel-edit-btn" onclick="resetForm()" class="hidden w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-xl">إلغاء التعديل</button>
                    </div>
                </section>

                <section class="card p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-sliders text-blue-900"></i> إعدادات المهام الأسبوعية
                    </h2>
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between items-center">
                            <label>إشراف الصلاة (20 د)</label>
                            <input type="number" id="task-prayer" value="10" class="w-16 p-1 border rounded text-center font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <label>إشراف الفسحة (25 د)</label>
                            <input type="number" id="task-break" value="15" class="w-16 p-1 border rounded text-center font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <label>إشراف الخروج (25 د)</label>
                            <input type="number" id="task-exit" value="8" class="w-16 p-1 border rounded text-center font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <label>المناداة (20 د)</label>
                            <input type="number" id="task-call" value="5" class="w-16 p-1 border rounded text-center font-bold">
                        </div>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="flex flex-wrap gap-3">
                    <button onclick="distributeTasks()" class="bg-blue-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition flex items-center gap-2">
                        <i class="fas fa-magic"></i> توزيع المهام إلكترونياً
                    </button>
                    <button onclick="clearAll()" class="bg-red-50 text-red-600 px-6 py-3 rounded-xl font-bold hover:bg-red-100 transition flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> مسح الكل
                    </button>
                </div>

                <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>

                <div class="card rounded-2xl overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                        <h2 class="text-xl font-bold">مقارنة العبء الزمني والفجوة</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead>
                                <tr class="bg-blue-900 text-white text-sm">
                                    <th class="p-4">المعلم</th>
                                    <th class="p-4 text-center">إجمالي الوقت</th>
                                    <th class="p-4">الفجوة الزمنية (المتبقي)</th>
                                    <th class="p-4 text-center">الإجراء</th>
                                </tr>
                            </thead>
                            <tbody id="analysis-table-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="4" class="p-10 text-center text-gray-400">لا يوجد بيانات حالياً</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        let teachers = [];
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        
        const TIMING = {
            sunTue: { p1: 40, p2: 40, p3: 40, p4: 35, p5: 35, p6: 35, p7: 35, p8: 40 },
            wedThu: { p1: 40, p2: 40, p3: 40, p4: 45, p5: 45, p6: 45, p7: 40, p8: 0 },
            tasks: { prayer: 20, break: 25, exit: 25, call: 20 }
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderDaySelectors();
            loadPersistentData();
        });

        function loadPersistentData() {
            const saved = localStorage.getItem('teacher_data_sultan');
            if (saved) {
                teachers = JSON.parse(saved);
                sortTeachers();
                updateUI();
            }
        }

        function saveData() {
            localStorage.setItem('teacher_data_sultan', JSON.stringify(teachers));
        }

        function sortTeachers() {
            // الترتيب من الأكثر ساعات إلى الأقل
            teachers.sort((a, b) => b.totalMinutes - a.totalMinutes);
        }

        function renderDaySelectors() {
            const container = document.getElementById('days-container');
            container.innerHTML = DAYS.map((day, idx) => `
                <div class="bg-white border rounded-xl p-3">
                    <p class="text-xs font-black text-blue-900 mb-2 uppercase tracking-wide">${day}</p>
                    <div class="grid grid-cols-4 gap-2">
                        ${[1,2,3,4,5,6,7,8].map(p => {
                            if ((idx >= 3) && p === 8) return ''; 
                            return `
                                <div onclick="togglePeriod(this, '${day}', ${p})" 
                                     class="period-box p-2 text-center rounded-lg text-xs font-bold"
                                     data-day="${day}" data-period="${p}">
                                    ${p}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function togglePeriod(el, day, p) {
            el.classList.toggle('selected');
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            if (hours === 0) return `${mins} د`;
            if (mins === 0) return `${hours} س`;
            return `${hours} س و ${mins} د`;
        }

        function addTeacher() {
            const name = document.getElementById('teacher-name').value.trim();
            const isHead = document.getElementById('is-head').checked;
            const editId = document.getElementById('edit-teacher-id').value;

            if (!name) return alert("يرجى إدخال اسم المعلم");

            const selectedPeriods = [];
            document.querySelectorAll('.period-box.selected').forEach(box => {
                const day = box.dataset.day;
                const p = parseInt(box.dataset.period);
                let time = (day === 'الأربعاء' || day === 'الخميس') ? TIMING.wedThu[`p${p}`] : TIMING.sunTue[`p${p}`];
                selectedPeriods.push({ day, p, time });
            });

            if (selectedPeriods.length === 0) return alert("يرجى اختيار حصة واحدة على الأقل");

            const classMinutes = selectedPeriods.reduce((sum, item) => sum + item.time, 0);

            if (editId) {
                // تحديث معلم موجود
                const index = teachers.findIndex(t => t.id == editId);
                if (index !== -1) {
                    teachers[index].name = name;
                    teachers[index].isHead = isHead;
                    teachers[index].selectedPeriods = selectedPeriods;
                    teachers[index].classMinutes = classMinutes;
                    teachers[index].totalMinutes = classMinutes + calculateTaskMinutes(teachers[index].tasks);
                }
            } else {
                // إضافة معلم جديد
                teachers.push({
                    id: Date.now(),
                    name,
                    isHead,
                    classMinutes,
                    selectedPeriods,
                    tasks: { prayer: 0, break: 0, exit: 0, call: 0 },
                    totalMinutes: classMinutes
                });
            }

            resetForm();
            sortTeachers();
            updateUI();
        }

        function calculateTaskMinutes(tasks) {
            return (tasks.prayer * 20) + (tasks.break * 25) + (tasks.exit * 25) + (tasks.call * 20);
        }

        function editTeacher(id) {
            const t = teachers.find(teacher => teacher.id == id);
            if (!t) return;

            document.getElementById('edit-teacher-id').value = t.id;
            document.getElementById('teacher-name').value = t.name;
            document.getElementById('is-head').checked = t.isHead;
            
            document.getElementById('form-title').innerHTML = `<i class="fas fa-edit text-amber-600"></i> تعديل بيانات: ${t.name}`;
            document.getElementById('save-btn').innerHTML = `<i class="fas fa-check"></i> تحديث بيانات المعلم`;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');

            // إعادة تعيين الحصص المحددة
            document.querySelectorAll('.period-box').forEach(box => {
                box.classList.remove('selected');
                const day = box.dataset.day;
                const p = parseInt(box.dataset.period);
                const isSelected = t.selectedPeriods.some(sp => sp.day === day && sp.p === p);
                if (isSelected) box.classList.add('selected');
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('edit-teacher-id').value = '';
            document.getElementById('teacher-name').value = '';
            document.getElementById('is-head').checked = false;
            document.getElementById('form-title').innerHTML = `<i class="fas fa-user-plus text-blue-900"></i> إضافة معلم جديد`;
            document.getElementById('save-btn').innerHTML = `<i class="fas fa-save"></i> حفظ المعلم`;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.querySelectorAll('.period-box').forEach(b => b.classList.remove('selected'));
        }

        function removeTeacher(id) {
            if(confirm('هل أنت متأكد من حذف هذا المعلم؟')) {
                teachers = teachers.filter(t => t.id !== id);
                updateUI();
            }
        }

        function clearAll() {
            if(confirm('سيتم مسح جميع المعلمين، هل أنت متأكد؟')) {
                teachers = [];
                updateUI();
            }
        }

        function distributeTasks() {
            if (teachers.length === 0) return;
            
            teachers.forEach(t => {
                t.tasks = { prayer: 0, break: 0, exit: 0, call: 0 };
                t.totalMinutes = t.classMinutes;
            });

            const taskSettings = {
                prayer: { count: parseInt(document.getElementById('task-prayer').value), time: 20 },
                break: { count: parseInt(document.getElementById('task-break').value), time: 25 },
                exit: { count: parseInt(document.getElementById('task-exit').value), time: 25 },
                call: { count: parseInt(document.getElementById('task-call').value), time: 20 }
            };

            Object.keys(taskSettings).forEach(taskKey => {
                let remaining = taskSettings[taskKey].count;
                while (remaining > 0) {
                    teachers.sort((a, b) => {
                        let loadA = a.totalMinutes + (a.isHead ? 150 : 0);
                        let loadB = b.totalMinutes + (b.isHead ? 150 : 0);
                        return loadA - loadB;
                    });
                    teachers[0].tasks[taskKey]++;
                    teachers[0].totalMinutes += taskSettings[taskKey].time;
                    remaining--;
                }
            });
            sortTeachers(); // إعادة الترتيب بعد توزيع المهام
            updateUI();
        }

        function updateUI() {
            saveData();
            renderTeachersGrid();
            renderAnalysisTable();
            updateStats();
        }

        function updateStats() {
            const total = teachers.length;
            const totalMins = teachers.reduce((sum, t) => sum + t.totalMinutes, 0);
            const avgMins = total > 0 ? totalMins / total : 0;
            const totalPeriods = teachers.reduce((sum, t) => sum + t.selectedPeriods.length, 0);

            document.getElementById('stat-total-teachers').innerText = total;
            document.getElementById('stat-avg-time').innerText = formatTime(avgMins);
            document.getElementById('stat-total-periods').innerText = totalPeriods;
        }

        function renderTeachersGrid() {
            const grid = document.getElementById('teachers-grid');
            if (teachers.length === 0) {
                grid.innerHTML = '';
                return;
            }
            grid.innerHTML = teachers.map(t => {
                const taskMins = calculateTaskMinutes(t.tasks);
                return `
                    <div class="card p-5 rounded-2xl relative overflow-hidden">
                        ${t.isHead ? '<div class="absolute top-0 left-0 bg-amber-100 text-amber-700 px-3 py-1 rounded-br-xl text-xs font-bold"><i class="fas fa-medal mr-1"></i> رئيس قسم</div>' : ''}
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-lg">${t.name}</h3>
                            <div class="flex gap-2">
                                <button onclick="editTeacher(${t.id})" class="text-blue-600 hover:text-blue-800 p-2"><i class="fas fa-edit"></i></button>
                                <button onclick="removeTeacher(${t.id})" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-slate-50 p-2 rounded-lg">
                                <span class="block text-gray-500 text-xs">حصص تدريس</span>
                                <span class="font-bold">${formatTime(t.classMinutes)} (${t.selectedPeriods.length})</span>
                            </div>
                            <div class="bg-blue-50 p-2 rounded-lg">
                                <span class="block text-blue-500 text-xs">مهام إضافية</span>
                                <span class="font-bold">${formatTime(taskMins)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAnalysisTable() {
            const tbody = document.getElementById('analysis-table-body');
            if (teachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400">لا يوجد بيانات حالياً</td></tr>';
                return;
            }

            const maxTime = Math.max(...teachers.map(t => t.totalMinutes));

            tbody.innerHTML = teachers.map(t => {
                const gap = maxTime - t.totalMinutes;
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-4 font-bold">${t.name}</td>
                        <td class="p-4 text-center font-black text-blue-700">${formatTime(t.totalMinutes)}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-200 h-2 rounded-full overflow-hidden">
                                    <div class="bg-blue-600 h-full" style="width: ${(t.totalMinutes/maxTime*100)}%"></div>
                                </div>
                                <span class="text-xs font-bold text-gray-500">${gap > 0 ? 'فجوة ' + formatTime(gap) : 'الأعلى'}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="editTeacher(${t.id})" class="text-blue-600 font-bold text-sm underline">تعديل</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
