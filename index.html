<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المهام التعليمية - سلطان الوليعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; color: #0a192f; }
        .gradient-header { background: linear-gradient(135deg, #0a192f 0%, #1e3a8a 100%); }
        .card { background: white; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .period-box { cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.2s; }
        .period-box.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #login-overlay { position: fixed; inset: 0; background: #0a192f; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center mx-4">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-lock text-blue-900 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black mb-6 text-blue-900">تسجيل الدخول</h2>
            <div class="space-y-4">
                <input type="text" id="user-input" placeholder="اسم المستخدم" class="w-full p-4 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 text-center font-bold">
                <input type="password" id="pass-input" placeholder="كلمة المرور" class="w-full p-4 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-500 text-center font-bold">
                <button onclick="checkLogin()" class="w-full bg-blue-800 text-white py-4 rounded-xl font-bold hover:bg-blue-900 transition shadow-lg">دخول</button>
            </div>
            <p id="error-msg" class="text-red-500 mt-4 text-sm font-bold hidden">خطأ في البيانات!</p>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        <header class="gradient-header text-white py-6 mb-8 shadow-lg relative">
            <div class="container mx-auto px-4 text-center">
                <button onclick="logout()" class="absolute left-4 top-1/2 -translate-y-1/2 bg-red-600/20 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs transition">خروج</button>
                <h1 class="text-3xl font-extrabold mb-1">نظام التوزيع الذكي للمهام التعليمية</h1>
                <p class="text-blue-100 opacity-90 text-sm">أ. سلطان الوليعي - إدارة مهام كل معلم بشكل مستقل</p>
            </div>
        </header>

        <main class="container mx-auto px-4 pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6">
                    <section class="card p-6 rounded-2xl shadow-sm border-t-4 border-blue-900">
                        <h2 id="form-title" class="text-xl font-bold mb-6 flex items-center gap-2 text-blue-900">
                            <i class="fas fa-user-plus"></i> إضافة معلم جديد
                        </h2>
                        
                        <div class="space-y-4">
                            <input type="hidden" id="edit-teacher-id" value="">
                            
                            <div>
                                <label class="block text-sm font-bold mb-2 text-gray-700">اسم المعلم</label>
                                <input type="text" id="teacher-name" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="اسم المعلم">
                            </div>

                            <div class="bg-blue-50 p-4 rounded-2xl space-y-3">
                                <p class="text-xs font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2">تخصيص المهام الأسبوعية لهذا المعلم (مرات التكرار):</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex flex-col">
                                        <label class="text-[10px] text-gray-500 mb-1">إشراف صلاة (20د)</label>
                                        <input type="number" id="task-prayer" value="0" min="0" class="p-2 rounded-lg border text-center font-bold outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[10px] text-gray-500 mb-1">إشراف فسحة (25د)</label>
                                        <input type="number" id="task-break" value="0" min="0" class="p-2 rounded-lg border text-center font-bold outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[10px] text-gray-500 mb-1">إشراف خروج (25د)</label>
                                        <input type="number" id="task-exit" value="0" min="0" class="p-2 rounded-lg border text-center font-bold outline-none">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[10px] text-gray-500 mb-1">المناداة (20د)</label>
                                        <input type="number" id="task-call" value="0" min="0" class="p-2 rounded-lg border text-center font-bold outline-none">
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                                <input type="checkbox" id="is-head" class="w-5 h-5 accent-blue-900 cursor-pointer">
                                <label for="is-head" class="text-sm font-bold cursor-pointer text-gray-700">رئيس قسم</label>
                            </div>

                            <div class="space-y-3">
                                <p class="text-sm font-bold text-gray-700 flex justify-between">
                                    <span>توزيع الحصص:</span>
                                    <span class="text-blue-600 text-xs" id="selected-count">0 حصص مختارة</span>
                                </p>
                                <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2 space-y-4" id="days-container"></div>
                            </div>

                            <div class="flex flex-col gap-2 pt-2">
                                <button id="save-btn" onclick="addTeacher()" class="w-full bg-blue-800 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-blue-900 transition shadow-md">
                                    <i class="fas fa-save"></i> حفظ البيانات
                                </button>
                                <button id="cancel-edit" onclick="resetForm()" class="hidden w-full bg-gray-100 text-gray-600 font-bold py-2 rounded-xl hover:bg-gray-200 transition">إلغاء التعديل</button>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border">
                        <h3 class="font-bold text-blue-900">المعلمون <span id="teacher-count" class="bg-blue-100 text-blue-700 px-2 rounded-lg text-sm">0</span></h3>
                        <button onclick="clearAll()" class="text-red-500 text-sm hover:underline"><i class="fas fa-trash-alt ml-1"></i> مسح الكل</button>
                    </div>

                    <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                    <div class="card rounded-2xl overflow-hidden shadow-sm border-none">
                        <div class="p-4 bg-white border-b font-bold flex items-center gap-2">
                            <i class="fas fa-balance-scale text-blue-900"></i> ميزان العدالة الزمنية
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right bg-white text-sm">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="p-4">المعلم</th>
                                        <th class="p-4 text-center">إجمالي الوقت</th>
                                        <th class="p-4">نسبة العبء</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-table-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let teachers = [];
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        const TIMING = {
            sunTue: { p1: 40, p2: 40, p3: 40, p4: 35, p5: 35, p6: 35, p7: 35, p8: 40 },
            wedThu: { p1: 40, p2: 40, p3: 40, p4: 45, p5: 45, p6: 45, p7: 40, p8: 0 }
        };

        function checkLogin() {
            const u = document.getElementById('user-input').value;
            const p = document.getElementById('pass-input').value;
            if (u === 'admin' && p === '2026') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                sessionStorage.setItem('isLogged', 'true');
            } else { document.getElementById('error-msg').classList.remove('hidden'); }
        }

        function logout() { sessionStorage.removeItem('isLogged'); location.reload(); }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isLogged') === 'true') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
            }
            renderDaySelectors();
            loadData();
        });

        function renderDaySelectors() {
            const container = document.getElementById('days-container');
            container.innerHTML = DAYS.map((day, idx) => `
                <div class="bg-white border rounded-xl p-3">
                    <p class="text-xs font-black text-gray-500 mb-2">${day}</p>
                    <div class="grid grid-cols-4 gap-2">
                        ${[1,2,3,4,5,6,7,8].map(p => {
                            if ((idx >= 3) && p === 8) return ''; 
                            return `<div onclick="toggleBox(this)" class="period-box p-2 text-center rounded-lg text-xs font-bold" data-day="${day}" data-period="${p}">${p}</div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleBox(el) { el.classList.toggle('selected'); updateSelectionCount(); }

        function updateSelectionCount() {
            const count = document.querySelectorAll('.period-box.selected').length;
            document.getElementById('selected-count').innerText = `${count} حصص مختارة`;
        }

        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            return h > 0 ? `${h} س و ${m} د` : `${m} د`;
        }

        function addTeacher() {
            const name = document.getElementById('teacher-name').value.trim();
            const isHead = document.getElementById('is-head').checked;
            const editId = document.getElementById('edit-teacher-id').value;
            
            // سحب قيم المهام الحالية من المربعات
            const prayer = parseInt(document.getElementById('task-prayer').value) || 0;
            const breakTime = parseInt(document.getElementById('task-break').value) || 0;
            const exit = parseInt(document.getElementById('task-exit').value) || 0;
            const call = parseInt(document.getElementById('task-call').value) || 0;
            
            if (!name) return alert("يرجى إدخال اسم المعلم");

            const selectedPeriods = [];
            document.querySelectorAll('.period-box.selected').forEach(box => {
                const day = box.dataset.day;
                const p = parseInt(box.dataset.period);
                let time = (day === 'الأربعاء' || day === 'الخميس') ? TIMING.wedThu[`p${p}`] : TIMING.sunTue[`p${p}`];
                selectedPeriods.push({ day, p, time });
            });

            const classMins = selectedPeriods.reduce((sum, item) => sum + item.time, 0);
            const tasksMins = (prayer * 20) + (breakTime * 25) + (exit * 25) + (call * 20);

            const teacherData = {
                id: editId ? parseInt(editId) : Date.now(),
                name,
                isHead,
                selectedPeriods,
                tasksConfig: { prayer, breakTime, exit, call }, // حفظ المهام لكل معلم
                classMinutes: classMins,
                tasksMinutes: tasksMins,
                totalMinutes: classMins + tasksMins
            };

            if (editId) {
                const index = teachers.findIndex(t => t.id == editId);
                teachers[index] = teacherData;
            } else {
                teachers.push(teacherData);
            }

            resetForm();
            updateUI();
        }

        function editTeacher(id) {
            const t = teachers.find(teacher => teacher.id == id);
            if (!t) return;
            document.getElementById('edit-teacher-id').value = t.id;
            document.getElementById('teacher-name').value = t.name;
            document.getElementById('is-head').checked = t.isHead;
            
            // استعادة مهام المعلم المحددة له سابقاً
            document.getElementById('task-prayer').value = t.tasksConfig?.prayer || 0;
            document.getElementById('task-break').value = t.tasksConfig?.breakTime || 0;
            document.getElementById('task-exit').value = t.tasksConfig?.exit || 0;
            document.getElementById('task-call').value = t.tasksConfig?.call || 0;

            document.getElementById('form-title').innerHTML = '<i class="fas fa-edit"></i> تعديل بيانات المعلم';
            document.getElementById('save-btn').innerText = 'تحديث البيانات';
            document.getElementById('cancel-edit').classList.remove('hidden');

            document.querySelectorAll('.period-box').forEach(box => {
                box.classList.remove('selected');
                if (t.selectedPeriods.find(p => p.day === box.dataset.day && p.p == box.dataset.period)) box.classList.add('selected');
            });
            updateSelectionCount();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('edit-teacher-id').value = '';
            document.getElementById('teacher-name').value = '';
            document.getElementById('is-head').checked = false;
            document.getElementById('task-prayer').value = 0;
            document.getElementById('task-break').value = 0;
            document.getElementById('task-exit').value = 0;
            document.getElementById('task-call').value = 0;
            document.getElementById('form-title').innerHTML = '<i class="fas fa-user-plus"></i> إضافة معلم جديد';
            document.getElementById('save-btn').innerText = 'حفظ البيانات';
            document.getElementById('cancel-edit').classList.add('hidden');
            document.querySelectorAll('.period-box').forEach(b => b.classList.remove('selected'));
            updateSelectionCount();
        }

        function removeTeacher(id) {
            if(confirm('حذف هذا المعلم؟')) { teachers = teachers.filter(t => t.id !== id); updateUI(); }
        }

        function clearAll() {
            if(confirm('حذف الكل؟')) { teachers = []; updateUI(); }
        }

        function updateUI() {
            localStorage.setItem('teacher_data_sultan', JSON.stringify(teachers));
            document.getElementById('teacher-count').innerText = teachers.length;
            const grid = document.getElementById('teachers-grid');
            grid.innerHTML = teachers.map(t => `
                <div class="card p-5 rounded-2xl relative shadow-sm border-r-4 ${t.isHead ? 'border-amber-400' : 'border-blue-600'}">
                    <div class="flex justify-between items-start mb-4">
                        <div><h3 class="font-bold text-lg">${t.name}</h3>${t.isHead ? '<span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold">رئيس قسم</span>' : ''}</div>
                        <div class="flex gap-2">
                            <button onclick="editTeacher(${t.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition"><i class="fas fa-edit"></i></button>
                            <button onclick="removeTeacher(${t.id})" class="text-red-400 hover:bg-red-50 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-2 rounded-lg border border-gray-100">
                            <span class="block text-gray-400 text-[10px] mb-1">وقت التدريس (${t.selectedPeriods.length} ح)</span>
                            <span class="font-bold text-gray-700">${formatTime(t.classMinutes)}</span>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg border border-blue-100">
                            <span class="block text-blue-400 text-[10px] mb-1">وقت المهام</span>
                            <span class="font-bold text-blue-700">${formatTime(t.tasksMinutes)}</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-dashed flex justify-between items-center font-black text-blue-900">
                        <span class="text-xs text-gray-400">الإجمالي الأسبوعي:</span>
                        <span>${formatTime(t.totalMinutes)}</span>
                    </div>
                </div>
            `).join('');

            const tbody = document.getElementById('analysis-table-body');
            const maxTime = Math.max(...teachers.map(t => t.totalMinutes), 1);
            tbody.innerHTML = teachers.sort((a,b) => b.totalMinutes - a.totalMinutes).map(t => `
                <tr class="hover:bg-blue-50/30 transition">
                    <td class="p-4"><div class="font-bold text-gray-700">${t.name}</div></td>
                    <td class="p-4 text-center font-black text-blue-800">${formatTime(t.totalMinutes)}</td>
                    <td class="p-4"><div class="w-full bg-gray-100 h-1.5 rounded-full"><div class="bg-blue-600 h-full rounded-full" style="width: ${(t.totalMinutes/maxTime*100)}%"></div></div></td>
                </tr>
            `).join('');
        }

        function loadData() {
            const saved = localStorage.getItem('teacher_data_sultan');
            if (saved) { teachers = JSON.parse(saved); updateUI(); }
        }
    </script>
</body>
</html>
